<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Big Cat Taxonomy — Polished Interactive Tree</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
  :root{
    --bg-a: #0e1a26;
    --bg-b: #142433;
    --panel: rgba(6,12,20,0.6);
    --muted: #93a3b6;
    --text: #e6eef6;
  }

  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text)}
  /* diagonal striped background */
  body{
    background:
      repeating-linear-gradient(45deg,
        var(--bg-a) 0 18px,
        var(--bg-b) 18px 36px
      );
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow:hidden;
  }

  /* top header */
  header{
    height:64px;
    display:flex;
    align-items:center;
    gap:16px;
    padding:10px 20px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-bottom: 1px solid rgba(255,255,255,0.03);
    box-shadow: 0 4px 18px rgba(2,6,23,0.45);
  }
  h1{font-size:16px;margin:0;font-weight:700;color:var(--text);letter-spacing:0.1px}
  .controls{display:flex;align-items:center;gap:8px}
  .btn{
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.04);
    color:var(--text);
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    transition: transform .12s ease, background .12s ease;
  }
  .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.06); }
  .legend{ margin-left:auto; display:flex; gap:14px; align-items:center; color:var(--muted); font-size:13px }
  .legend-item{ display:flex; gap:8px; align-items:center; }
  .swatch{ width:11px; height:11px; border-radius:50%; box-shadow: 0 1px 4px rgba(2,6,23,0.6) }

  /* canvas area */
  #canvas{ width:100%; height: calc(100vh - 64px); position:relative; }
  svg{ width:100%; height:100%; display:block; }

  /* links + nodes */
  .link{ fill:none; stroke: rgba(255,255,255,0.07); stroke-width:1.4px; }
  .node circle{ stroke: rgba(2,6,23,0.85); stroke-width:1.2px; cursor:pointer; }
  .node text{ font-weight:700; font-size:13px; fill: var(--text); paint-order: stroke; stroke: rgba(2,6,23,0.85); stroke-width:2px; pointer-events:none; }
  .label-rect{ fill: rgba(2,6,23,0.72); rx:8; ry:8; }

  /* tooltip card (polished like your screenshot) */
  .tooltip{
    position: fixed;
    pointer-events: none;
    background: linear-gradient(180deg, rgba(10,16,24,0.98), rgba(7,12,18,0.98));
    border-radius: 10px;
    padding: 12px 14px;
    color: #e6eef6;
    box-shadow: 0 10px 30px rgba(2,6,23,0.7);
    border: 1px solid rgba(255,255,255,0.03);
    max-width: 360px;
    font-size: 14px;
    line-height: 1.45;
    opacity: 0;
    transition: opacity 160ms ease, transform 160ms ease;
    transform-origin: 0 0;
    z-index: 9999;
  }
  .tooltip.show{ opacity: 1; transform: translateY(-4px); }
  .tooltip h2{ margin:0; font-size:15px; font-weight:700; color: #ffffff; }
  .tooltip em{ display:block; margin-top:6px; color: #cbd5e1; font-style:italic; font-weight:500; }
  .tooltip .meta{ margin-top:8px; font-size:12px; color:#94a3b8; }
  .tooltip p{ margin:10px 0 0 0; color:#dbeafe; font-size:13px; }

  @media (max-width:900px){
    .legend{ display:none }
    .tooltip{ max-width: 260px; font-size:13px }
  }
</style>
</head>
<body>

<header>
  <h1>Big Cat Taxonomy Tree</h1>

  <div class="controls" role="toolbar" aria-label="Controls">
    <button class="btn" id="expandAll">Expand all</button>
    <button class="btn" id="collapseGenera">Collapse to genera</button>
    <button class="btn" id="resetView">Reset view</button>
  </div>

  <div class="legend" aria-hidden>
    <div class="legend-item"><span class="swatch" style="background:#fbbf24"></span>Family</div>
    <div class="legend-item"><span class="swatch" style="background:#06b6d4"></span>Subfamily</div>
    <div class="legend-item"><span class="swatch" style="background:#ef4444"></span>Panthera</div>
    <div class="legend-item"><span class="swatch" style="background:#a78bfa"></span>Neofelis</div>
    <div class="legend-item"><span class="swatch" style="background:#3b82f6"></span>Acinonyx</div>
    <div class="legend-item"><span class="swatch" style="background:#22c55e"></span>Puma</div>
  </div>
</header>

<div id="canvas">
  <svg id="svgRoot" viewBox="0 0 1600 900" preserveAspectRatio="xMidYMid meet"></svg>
  <div class="tooltip" id="tooltip" role="dialog" aria-hidden="true"></div>
</div>

<script>
/* ======= DATA ======= */
/* Rich hierarchical data with ranks, latin names (sci), descriptions, and colors for genera/species */
const TAXON = {
  name: 'Felidae',
  rank: 'Family',
  sci: 'Felidae',
  description: 'Felidae — the cat family. Carnivorous mammals characterized by retractable claws, keen senses, and acute predatory skills.',
  color: '#fbbf24',
  children: [
    {
      name: 'Pantherinae',
      rank: 'Subfamily',
      sci: 'Pantherinae',
      color: '#06b6d4',
      children: [
        {
          name: 'Panthera',
          rank: 'Genus',
          color: '#ef4444',
          children: [
            { name: 'Lion', sci: 'Panthera leo', rank: 'Species', description: "Social big cat living in prides; apex predator of African savannas and India's Gir Forest.", color: '#ef4444' },
            { name: 'Tiger', sci: 'Panthera tigris', rank: 'Species', description: 'Largest of the big cats; solitary ambush predator native to Asia.', color: '#ef4444' },
            { name: 'Jaguar', sci: 'Panthera onca', rank: 'Species', description: 'Powerful feline of the Americas; noted for a very strong bite and affinity for water.', color: '#ef4444' },
            { name: 'Leopard', sci: 'Panthera pardus', rank: 'Species', description: 'Adaptable solitary cat with rosette-patterned coat across Africa and Asia.', color: '#ef4444' },
            { name: 'Snow Leopard', sci: 'Panthera uncia', rank: 'Species', description: 'High-altitude specialist of Central Asia with thick fur and long tail for balance.', color: '#ef4444' }
          ]
        },
        {
          name: 'Neofelis',
          rank: 'Genus',
          color: '#a78bfa',
          children: [
            { name: 'Clouded Leopard', sci: 'Neofelis nebulosa', rank: 'Species', description: 'Medium-sized arboreal felid of Southeast Asia with cloud-like spots and exceptional climbing ability.', color: '#a78bfa' },
            { name: 'Sunda Clouded Leopard', sci: 'Neofelis diardi', rank: 'Species', description: 'Island relative found in Borneo and Sumatra, recently recognized as a separate species.', color: '#a78bfa' }
          ]
        }
      ]
    },
    {
      name: 'Felinae',
      rank: 'Subfamily',
      sci: 'Felinae',
      color: '#06b6d4',
      children: [
        {
          name: 'Acinonyx',
          rank: 'Genus',
          color: '#3b82f6',
          children: [
            { name: 'Cheetah', sci: 'Acinonyx jubatus', rank: 'Species', description: 'Built for speed — the fastest land mammal; semi-retractable claws and long limbs for sprinting.', color: '#3b82f6' }
          ]
        },
        {
          name: 'Puma',
          rank: 'Genus',
          color: '#22c55e',
          children: [
            { name: 'Cougar', sci: 'Puma concolor', rank: 'Species', description: 'Wide-ranging American felid with many regional names; solitary and adaptable.', color: '#22c55e' }
          ]
        }
      ]
    }
  ]
};

/* ======= SETUP SVG, ZOOM/PAN, DIMENSIONS ======= */
const svg = d3.select('#svgRoot');
const canvasDiv = document.getElementById('canvas');
let width = canvasDiv.clientWidth;
let height = canvasDiv.clientHeight;

svg.attr('viewBox', `0 0 ${width} ${height}`);

const g = svg.append('g').attr('transform', 'translate(120,40)'); // initial group, zoom will modify transform

const initialTransform = d3.zoomIdentity.translate(120,40).scale(1);

const zoom = d3.zoom()
  .scaleExtent([0.45, 3])
  .on('zoom', (event) => { g.attr('transform', event.transform); });

svg.call(zoom).call(zoom.transform, initialTransform);

/* tree layout */
const tree = d3.tree().size([height - 160, width - 320]);

/* root hierarchy */
let root = d3.hierarchy(TAXON);
root.x0 = height / 2;
root.y0 = 0;

/* utility: assign unique ids to data nodes */
let uid = 0;
function assignUIDs(node){
  node.data._uid = ++uid;
  if(node.children) node.children.forEach(assignUIDs);
  if(node._children) node._children.forEach(assignUIDs);
}
assignUIDs(root);

/* collapse helper (for generic collapse) */
function collapse(d){
  if(d.children){
    d._children = d.children;
    d._children.forEach(collapse);
    d.children = null;
  }
}

/* collapse-to-genera: keep family->subfamily->genus expanded; collapse species under genus */
function collapseToGenera(rootNode){
  // ensure top levels are expanded: family and subfamilies
  if(rootNode.children){
    rootNode.children.forEach(sub => {
      // ensure sub is expanded (open)
      if(sub._children){ sub.children = sub._children; sub._children = null; }
      if(sub.children){
        sub.children.forEach(gen => {
          // collapse species under each genus
          if(gen.children){
            gen._children = gen.children;
            gen.children = null;
          }
        });
      }
    });
  }
}

/* run initial collapse-to-genera */
collapseToGenera(root);

/* ======= TOOLTIP ======= */
const tooltip = d3.select('#tooltip');

function showTooltip(d, event){
  // Build tooltip HTML with polished layout
  const genus = getAncestorRank(d, 'Genus');
  const title = d.data.name || '';
  const sci = d.data.sci || '';
  const rank = d.data.rank || '';
  const desc = d.data.description || (d.data.rank === 'Genus' ? `Genus ${d.data.name}` : '');

  let html = `<h2>${title}</h2>`;
  if(sci) html += `<em>${sci}</em>`;
  html += `<div class="meta">Rank: ${rank}${genus ? ` · Genus: ${genus}` : ''}</div>`;
  if(desc) html += `<p>${desc}</p>`;

  tooltip.html(html).classed('show', true).attr('aria-hidden','false');

  // position: stay inside window bounds
  const pageX = event.pageX;
  const pageY = event.pageY;
  const tt = document.getElementById('tooltip');
  const ttRect = tt.getBoundingClientRect();
  let left = pageX + 14;
  let top = pageY + 14;

  // clamp to right edge
  const pad = 12;
  if(left + ttRect.width + pad > window.innerWidth) left = pageX - ttRect.width - 18;
  if(top + ttRect.height + pad > window.innerHeight) top = pageY - ttRect.height - 18;
  tooltip.style('left', left + 'px').style('top', top + 'px');
}

function hideTooltip(){
  tooltip.classed('show', false).attr('aria-hidden','true');
}

/* helper: find ancestor name of given rank */
function getAncestorRank(node, rankName){
  let cur = node;
  while(cur.parent){
    cur = cur.parent;
    if(cur.data.rank === rankName) return cur.data.name;
  }
  return null;
}

/* ======= RENDER / UPDATE ======= */
function update(source) {
  // recalc size & layout (responsive)
  width = canvasDiv.clientWidth;
  height = canvasDiv.clientHeight;
  svg.attr('viewBox', `0 0 ${width} ${height}`);
  tree.size([height - 160, width - 320]);

  const duration = 420;
  const nodes = root.descendants();
  const links = root.links();

  // normalize horizontal spacing
  nodes.forEach(d => d.y = d.depth * 180);

  // LINKS
  const link = g.selectAll('path.link').data(links, d => d.target.data._uid);

  // enter
  const linkEnter = link.enter().insert('path', 'g')
    .attr('class','link')
    .attr('d', d => {
      const o = {x: source.x0 || root.x0, y: source.y0 || root.y0};
      return diagonal(o, o);
    })
    .style('stroke', 'rgba(255,255,255,0.06)')
    .style('stroke-width', 1.4)
    .style('opacity', 0.0);

  // update + transition
  linkEnter.merge(link)
    .transition().duration(duration)
    .style('opacity', 1.0)
    .attrTween('d', function(d) {
      const i0 = d3.interpolatePath(this.getAttribute('d'), diagonal(d.source, d.target));
      return t => i0(t);
    });

  // exit
  link.exit().transition().duration(duration)
    .style('opacity', 0)
    .attr('d', d => {
      const o = {x: source.x, y: source.y};
      return diagonal(o, o);
    })
    .remove();

  // NODES
  const node = g.selectAll('g.node').data(nodes, d => d.data._uid);

  const nodeEnter = node.enter().append('g')
    .attr('class','node')
    .attr('transform', d => `translate(${source.y0 || root.y0},${source.x0 || root.x0})`)
    .on('click', (event,d) => {
      // toggle children
      if (d.children) { d._children = d.children; d.children = null; }
      else { d.children = d._children; d._children = null; }
      update(d);
    })
    .on('mouseover', function(event,d){
      showTooltip(d, event);
      // subtle circle pulse
      d3.select(this).select('circle').transition().duration(220).attr('r', rForDepth(d)+4).transition().duration(400).attr('r', rForDepth(d));
    })
    .on('mousemove', function(event,d){ showTooltip(d, event); })
    .on('mouseout', function(){ hideTooltip(); });

  // circle
  nodeEnter.append('circle')
    .attr('r', 0.1)
    .style('fill', d => d.data.color || (d.depth === 0 ? '#fbbf24' : (d.depth === 1 ? '#06b6d4' : '#94a3b8')))
    .style('stroke', 'rgba(255,255,255,0.06)');

  // label rect (behind text). append first so it's behind
  nodeEnter.append('rect')
    .attr('class','label-rect')
    .attr('width', 1).attr('height', 1)
    .attr('x', 0).attr('y', 0)
    .style('opacity', d => d.depth >= 2 ? 0.92 : 0.7);

  // text
  nodeEnter.append('text')
    .attr('dy', '0.35em')
    .attr('x', d => (d._children || d.children) ? -12 : 12)
    .attr('text-anchor', d => (d._children || d.children) ? 'end' : 'start')
    .text(d => {
      // show common / readable labels:
      if (d.data.rank === 'Species' && d.data.name) return d.data.name;
      if (d.data.rank === 'Genus') return d.data.name;
      if (d.data.rank === 'Subfamily') return d.data.name.replace(/\s*\(.*\)$/, '');
      return d.data.name;
    })
    .style('fill', 'var(--text)');

  // MERGE
  const nodeUpdate = nodeEnter.merge(node);

  // Compute text bounding boxes for label rects and set positions
  nodeUpdate.select('text').each(function(d){
    const textEl = this;
    const bbox = textEl.getBBox();
    const padX = 12, padY = 8;
    // decide anchor: left for collapsed/parent nodes, right for leaves
    const isLeft = (d._children || d.children);
    const rectWidth = bbox.width + padX * 2;
    const rectHeight = bbox.height + padY;
    // compute rect position so it nicely frames the text
    const rectX = isLeft ? -rectWidth + 6 : -6;
    const rectY = -rectHeight/2 + 2;
    d3.select(this.parentNode).select('rect.label-rect')
      .attr('x', rectX)
      .attr('y', rectY)
      .attr('width', rectWidth)
      .attr('height', rectHeight)
      .style('opacity', d.depth >= 2 ? 0.92 : 0.68);
    // position text anchored with small offset inside rect
    const textX = isLeft ? (-rectWidth + padX + 6 + bbox.width) - (bbox.width) : (-rectWidth + padX + 6 + bbox.width) - (bbox.width) + padX - (padX-6);
    // simpler: set text x to -10 for left, 10 for right to keep consistent spacing
    d3.select(this).attr('x', isLeft ? -12 : 12).attr('text-anchor', isLeft ? 'end' : 'start');
  });

  // transitions: move to new positions
  nodeUpdate.transition().duration(duration)
    .attr('transform', d => `translate(${d.y},${d.x})`);

  nodeUpdate.select('circle').transition().duration(duration)
    .attr('r', d => rForDepth(d))
    .style('fill', d => d.data.color || (d.depth === 0 ? '#fbbf24' : (d.depth === 1 ? '#06b6d4' : '#94a3b8')));

  // exit
  const nodeExit = node.exit().transition().duration(duration)
    .attr('transform', d => `translate(${source.y},${source.x})`)
    .style('opacity', 0)
    .remove();
  nodeExit.select('circle').attr('r', 1e-6);

  // store positions for smooth transitions next time
  nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
}

/* helper to determine circle radius by depth */
function rForDepth(d){
  if(d.depth === 0) return 10;       // family
  if(d.depth === 1) return 8;        // subfamily
  if(d.depth === 2) return 7;        // genus
  return 6;                          // species
}

/* diagonal cubic path (smooth) */
function diagonal(s, d){
  const sx = s.x, sy = s.y;
  const dx = d.x, dy = d.y;
  const mx = (sy + dy) / 2;
  return `M ${sy} ${sx} C ${mx} ${sx} ${mx} ${dx} ${dy} ${dx}`;
}

/* initial draw */
update(root);

/* ======= CONTROLS ======= */
function expandAll(){
  expandRec(root);
  update(root);
}
function expandRec(node){
  if(node._children){
    node.children = node._children;
    node._children = null;
  }
  if(node.children) node.children.forEach(expandRec);
}

function collapseGenera(){
  // collapse all, then reopen family->subfamily->genus levels; species collapsed
  // first fully collapse
  collapse(root);
  // now open family and each subfamily (depth 1)
  if(root._children){
    root.children = root._children;
    root._children = null;
  }
  if(root.children){
    root.children.forEach(sub => {
      if(sub._children){
        sub.children = sub._children;
        sub._children = null;
      }
      // for each genus under sub, ensure species are collapsed (i.e., species moved to _children)
      if(sub.children){
        sub.children.forEach(gen => {
          if(gen.children){
            gen._children = gen.children;
            gen.children = null;
          }
        });
      }
    });
  }
  update(root);
}

/* reset view (zoom) */
function resetView(){
  svg.transition().duration(650).call(zoom.transform, initialTransform);
}

/* helper: get genus name for tooltip */
function getGenusName(d){
  let cur = d;
  while(cur && cur.depth > 0){
    if(cur.data.rank === 'Genus') return cur.data.name;
    cur = cur.parent;
  }
  return '';
}

/* UI bindings */
document.getElementById('expandAll').addEventListener('click', () => { expandAll(); });
document.getElementById('collapseGenera').addEventListener('click', () => { collapseGenera(); });
document.getElementById('resetView').addEventListener('click', () => { resetView(); });

/* helper: find genus ancestor for tooltip meta (robust) */
function getAncestorRank(node, rank){
  let cur = node;
  while(cur.parent){
    cur = cur.parent;
    if(cur.data.rank === rank) return cur.data.name;
  }
  return null;
}

/* resize responsiveness */
let resizeTO = null;
window.addEventListener('resize', () => {
  clearTimeout(resizeTO);
  resizeTO = setTimeout(() => {
    width = canvasDiv.clientWidth;
    height = canvasDiv.clientHeight;
    svg.attr('viewBox', `0 0 ${width} ${height}`);
    update(root);
  }, 150);
});

/* assign hover tooltip content override to show Genus properly */
function showTooltip(d, e){
  // wrapper to keep consistent content (not used; kept for compatibility)
}

/* Note: tooltip show/hide handled in node mouse events above */

</script>
</body>
</html>
